{% comment %}
  Collection page template with dynamic customization options
  Features:
  - Collection image with text overlay/outside options
  - Optional breadcrumbs
  - Associated categories (via metafields)
  - Filter sidebar
  - Customizable product grid
  - Pagination or infinite loading
  - Optional collection description
{% endcomment %}

{% assign section_settings = section.settings %}
{% assign show_breadcrumbs = section_settings.show_breadcrumbs %}
{% assign text_position = section_settings.text_position %}
{% assign show_categories = section_settings.show_categories %}
{% assign products_per_row_mobile = section_settings.products_per_row_mobile %}

{% assign products_per_row_desktop = section_settings.products_per_row_desktop %}
{% assign products_per_page = section_settings.products_per_page %}
{% assign loading_type = section_settings.loading_type %}
{% assign description_position = section_settings.description_position %}

<div class="collection-container container mx-auto">
  {% if show_breadcrumbs %}
    <div class="breadcrumb-container py-3">
      {%  render 'breadcrumbs' %}
    </div>
  {% endif %}

  {% if collection.image %}
    <div class="collection-header relative mb-8">
      <div class="collection-image-container relative">
        <img 
          src="{{ collection.image | img_url: 'master' }}"
          alt="{{ collection.title | escape }}"
          class="w-full object-cover h-[300px] md:h-[400px]"
          loading="lazy"
          width="{{ collection.image.width }}"
          height="{{ collection.image.height }}"
        >
        
        {% if text_position == 'overlay' %}
          <div class="absolute inset-0 flex items-center justify-center bg-black bg-opacity-40">
            <div class="text-center text-white px-4">
              <h1 class="text-3xl md:text-4xl font-bold mb-2">{{ collection.title }}</h1>
              {% if collection.description != blank and description_position == 'header' %}
                <div class="collection-description max-w-2xl mx-auto">
                  {{ collection.description }}
                </div>
              {% endif %}
            </div>
          </div>
        {% endif %}
      </div>
      
      {% if text_position == 'below' %}
        <div class="text-center my-6">
          <h1 class="text-3xl md:text-4xl font-bold mb-2">{{ collection.title }}</h1>
          {% if collection.description != blank and description_position == 'header' %}
            <div class="collection-description max-w-2xl mx-auto">
              {{ collection.description }}
            </div>
          {% endif %}
        </div>
      {% endif %}
    </div>
  {% else %}
    <div class="collection-header-no-image text-center my-8">
      <h1 class="text-3xl md:text-4xl font-bold mb-2">{{ collection.title }}</h1>
      {% if collection.description != blank and description_position == 'header' %}
        <div class="collection-description max-w-2xl mx-auto">
          {{ collection.description }}
        </div>
      {% endif %}
    </div>
  {% endif %}

  {% if show_categories and collection.metafields.custom.associated_categories %}
    <div class="associated-categories mb-6">
      <div class="flex flex-wrap gap-2 justify-center">
        {% for category in collection.metafields.custom.associated_categories.value %}
          <a href="{{ category.url }}" class="px-4 py-2 bg-gray-100 hover:bg-gray-200 rounded-full text-sm transition">
            {{ category.title }}
          </a>
        {% endfor %}
      </div>
    </div>
  {% endif %}

  <div class="collection-content grid grid-cols-1 md:grid-cols-[250px_1fr] gap-8">
    <div class="filter-sidebar">
      {% render 'collection-filters', collection: collection %}
    </div>
    
    <div class="products-grid">
      {% if collection.products.size > 0 %}
        <div id="product-grid" 
          class="grid grid-cols-{{ products_per_row_mobile }} lg:grid-cols-{{ products_per_row_desktop }} gap-4">
          {% for product in collection.products limit: products_per_page %}
            <div class="product-card-wrapper">
              {% render 'product-card',
                product: product,
                show_secondary_image: section_settings.show_secondary_image,
                show_add_to_cart: section_settings.show_add_to_cart,
                variant_selector: section_settings.variant_selector,
                badge_type: section_settings.badge_type,
                show_pack_size: section_settings.show_pack_size,
                show_sku: section_settings.show_sku,
                show_rating: section_settings.show_rating,
                show_wishlist: section_settings.show_wishlist,
                title_lines: section_settings.title_lines,
                lazy_load: true
              %}
            </div>
          {% endfor %}
        </div>
        
        {% if loading_type == 'pagination' %}
          <div class="pagination-container flex justify-center mt-8">
            {% render 'pagination', pagination: paginate %}
          </div>
        {% elsif loading_type == 'infinite' %}
          <div class="infinite-loading mt-8 text-center" data-next-url="{{ paginate.next.url }}">
            <div id="loading-indicator" class="hidden">
              <div class="w-10 h-10 border-4 border-gray-300 border-t-blue-500 rounded-full animate-spin mx-auto"></div>
              <p class="mt-2">Loading more products...</p>
            </div>
            <button id="load-more" class="px-6 py-3 bg-gray-100 hover:bg-gray-200 rounded-md transition">
              Load more products
            </button>
          </div>
        {% endif %}
      {% else %}
        <div class="empty-collection text-center py-12">
          <p class="text-lg">No products found in this collection.</p>
          <a href="/collections" class="inline-block mt-4 px-6 py-3 bg-gray-100 hover:bg-gray-200 rounded-md transition">
            Browse all collections
          </a>
        </div>
      {% endif %}
      
      {% if collection.description != blank and description_position == 'footer' %}
        <div class="collection-description mt-16 max-w-4xl mx-auto">
          <h2 class="text-2xl font-bold mb-4">About {{ collection.title }}</h2>
          {{ collection.description }}
        </div>
      {% endif %}
    </div>
  </div>
</div>

{% schema %}
{
  "name": "Collection Page",
  "disabled_on": {
    "groups": ["header", "footer"]
  },
  "settings": [
    {
      "type": "header",
      "content": "Collection Header"
    },
    {
      "type": "checkbox",
      "id": "show_breadcrumbs",
      "label": "Show breadcrumbs",
      "default": true
    },
    {
      "type": "select",
      "id": "text_position",
      "label": "Collection title position",
      "options": [
        {
          "value": "overlay",
          "label": "Overlay on image"
        },
        {
          "value": "below",
          "label": "Below image"
        }
      ],
      "default": "overlay"
    },
    {
      "type": "checkbox",
      "id": "show_categories",
      "label": "Show associated categories",
      "info": "Display associated categories from collection metafields",
      "default": true
    },
    {
      "type": "header",
      "content": "Product Grid"
    },
    {
      "type": "range",
      "id": "products_per_row_mobile",
      "label": "Products per row (mobile)",
      "min": 1,
      "max": 3,
      "step": 1,
      "default": 2
    },
    {
      "type": "range",
      "id": "products_per_row_desktop",
      "label": "Products per row (desktop)",
      "min": 2,
      "max": 5,
      "step": 1,
      "default": 4
    },
    {
      "type": "range",
      "id": "products_per_page",
      "label": "Products per page",
      "min": 4,
      "max": 48,
      "step": 4,
      "default": 16
    },
    {
      "type": "select",
      "id": "loading_type",
      "label": "Loading type",
      "options": [
        {
          "value": "pagination",
          "label": "Pagination"
        },
        {
          "value": "infinite",
          "label": "Infinite loading"
        }
      ],
      "default": "pagination"
    },
    {
      "type": "select",
      "id": "description_position",
      "label": "Description position",
      "options": [
        {
          "value": "header",
          "label": "After collection header"
        },
        {
          "value": "footer",
          "label": "After products"
        },
        {
          "value": "none",
          "label": "Do not show"
        }
      ],
      "default": "footer"
    },
    {
      "type": "header",
      "content": "Product Card Settings"
    },
    {
      "type": "checkbox",
      "id": "show_secondary_image",
      "label": "Show secondary image on hover",
      "default": true
    },
    {
      "type": "checkbox",
      "id": "show_add_to_cart",
      "label": "Show add to cart button",
      "default": true
    },
    {
      "type": "select",
      "id": "variant_selector",
      "label": "Variant selector type",
      "options": [
        {
          "value": "dropdown",
          "label": "Dropdown"
        },
        {
          "value": "list",
          "label": "Button list"
        },
        {
          "value": "images",
          "label": "Color/image swatches"
        },
        {
          "value": "none",
          "label": "None"
        }
      ],
      "default": "dropdown"
    },
    {
      "type": "select",
      "id": "badge_type",
      "label": "Sale badge type",
      "options": [
        {
          "value": "percentage",
          "label": "Discount percentage"
        },
        {
          "value": "amount",
          "label": "Saving amount"
        },
        {
          "value": "text",
          "label": "Sale text"
        },
        {
          "value": "none",
          "label": "None"
        }
      ],
      "default": "percentage"
    },
    {
      "type": "checkbox",
      "id": "show_pack_size",
      "label": "Show pack size",
      "default": true
    },
    {
      "type": "checkbox",
      "id": "show_sku",
      "label": "Show SKU",
      "default": false
    },
    {
      "type": "checkbox",
      "id": "show_rating",
      "label": "Show product rating",
      "default": true
    },
    {
      "type": "checkbox",
      "id": "show_wishlist",
      "label": "Show wishlist button",
      "default": true
    },
    {
      "type": "range",
      "id": "title_lines",
      "label": "Product title lines",
      "min": 1,
      "max": 3,
      "step": 1,
      "default": 2
    }
  ]
}
{% endschema %}